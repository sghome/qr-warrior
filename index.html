<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enlaces por IP</title>
  <script>
    // Lista de enlaces disponibles
    const links = [
      { url: 'https://backend.trak.codes/api/v0/pdf/single-case?source=GSheets&filename=pass.pdf&cextid=ad415fb4-aaa6-48eb-bef6-b959e647a6eb&inline=true', usedBy: null },
      { url: 'https://backend.trak.codes/api/v0/pdf/single-case?source=GSheets&filename=pass.pdf&cextid=b39924a8-7f0e-486e-8741-1a0d00025ec7&inline=true', usedBy: null },
      { url: 'https://backend.trak.codes/api/v0/pdf/single-case?source=GSheets&filename=pass.pdf&cextid=43466a81-37df-4a48-991d-148c982b385c&inline=true', usedBy: null },
    ];

    // Función para obtener la IP pública del usuario
    async function getUserIP() {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      return data.ip;
    }

    // Función para almacenar o recuperar el registro de IPs y enlaces
    function getStorageData() {
      const data = localStorage.getItem('ipLinks');
      return data ? JSON.parse(data) : {};
    }

    // Función para guardar el registro de IPs y enlaces
    function saveStorageData(data) {
      localStorage.setItem('ipLinks', JSON.stringify(data));
    }

    // Función para generar y mostrar el enlace
    async function generateLink() {
      const ip = await getUserIP(); // Obtener la IP del usuario
      const ipLinks = getStorageData(); // Obtener los registros actuales de IPs y enlaces

      // Verificar si esta IP ya ha visitado todos los enlaces
      if (Object.keys(ipLinks).length === links.length) {
        document.getElementById('message').style.display = 'block'; // Mostrar el mensaje
        return;
      }

      // Verificar si la IP ya tiene un enlace asignado
      if (ipLinks[ip]) {
        alert('Esta IP ya ha descargado un enlace.');
        return;
      }

      // Buscar un enlace disponible
      const availableLink = links.find(link => link.usedBy === null);

      if (!availableLink) {
        alert('No hay más enlaces disponibles.');
        return;
      }

      // Asignar el enlace a la IP
      ipLinks[ip] = availableLink.url;
      availableLink.usedBy = ip; // Marcar que este enlace ha sido usado por esta IP
      saveStorageData(ipLinks);

      // Mostrar el enlace en el navegador
      const linkElement = document.getElementById('dynamicLink');
      linkElement.href = availableLink.url;
      linkElement.target = '_blank'; // Abrir en una nueva ventana
      linkElement.innerText = `Descargar Código PDF`;
      linkElement.style.display = 'block'; // Asegurarse de que el enlace sea visible
    }

    // Esperar a que el documento se haya cargado completamente
    document.addEventListener("DOMContentLoaded", function() {
      // Evento de clic en el botón para generar el enlace
      document.getElementById('getLinkButton').addEventListener('click', generateLink);
    });
  </script>
  <style>
    /* Estilos básicos */
    #content {
      text-align: center;
      padding: 20px;
    }
    #getLinkButton {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
    }
    #dynamicLink {
      display: none;
      margin-top: 20px;
    }
    #message {
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="content">
    <h1>¡Genera tu enlace único!</h1>
    <p>Cada usuario puede obtener un único enlace para descargar el código PDF. ¡Sé rápido antes de que se acaben los enlaces!</p>

    <button id="getLinkButton">Generar enlace de descarga</button>

    <a id="dynamicLink" href="#" target="_blank"></a>

    <!-- Mensaje si los enlaces se han agotado -->
    <div id="message">
      <p>¡Todos los enlaces han sido asignados! Gracias por participar.</p>
    </div>
  </div>
</body>
</html>
