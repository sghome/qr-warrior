<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enlaces por IP</title>
  <script>
    // Lista de enlaces disponibles
    const links = [
      { url: 'https://backend.trak.codes/api/v0/pdf/single-case?source=GSheets&filename=pass.pdf&cextid=ad415fb4-aaa6-48eb-bef6-b959e647a6eb&inline=true', used: false },
      { url: 'https://backend.trak.codes/api/v0/pdf/single-case?source=GSheets&filename=pass.pdf&cextid=b39924a8-7f0e-486e-8741-1a0d00025ec7&inline=true', used: false },
      { url: 'https://backend.trak.codes/api/v0/pdf/single-case?source=GSheets&filename=pass.pdf&cextid=43466a81-37df-4a48-991d-148c982b385c&inline=true', used: false },
    ];

    // Función para obtener la IP pública del usuario
    async function getUserIP() {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      return data.ip;
    }

    // Función para registrar enlaces usados y asignar uno nuevo
    function getStorageData() {
      const data = localStorage.getItem('assignedLinks');
      return data ? JSON.parse(data) : { usedLinks: [], ipRecords: {} };
    }

    function saveStorageData(data) {
      localStorage.setItem('assignedLinks', JSON.stringify(data));
    }

    function updateCounter() {
      const storageData = getStorageData();
      const totalLinks = links.length;
      const usedLinks = storageData.usedLinks.length;
      const availableLinks = totalLinks - usedLinks;

      document.getElementById('usedLinksCount').innerText = usedLinks;
      document.getElementById('availableLinksCount').innerText = availableLinks;
    }

    async function generateLink() {
      const ip = await getUserIP(); // Obtener IP
      const storageData = getStorageData(); // Obtener datos del almacenamiento local

      // Verificar si la IP ya tiene un enlace asignado
      if (storageData.ipRecords[ip]) {
        alert('Ya tienes un enlace asignado.');
        const linkElement = document.getElementById('dynamicLink');
        linkElement.href = storageData.ipRecords[ip];
        linkElement.innerText = 'Volver a tu enlace asignado';
        linkElement.style.display = 'block';
        updateCounter();
        return;
      }

      // Buscar el siguiente enlace disponible
      const nextLink = links.find(link => !storageData.usedLinks.includes(link.url));

      if (!nextLink) {
        alert('No hay más enlaces disponibles.');
        document.getElementById('message').style.display = 'block';
        return;
      }

      // Asignar el enlace y registrar la IP
      storageData.ipRecords[ip] = nextLink.url;
      storageData.usedLinks.push(nextLink.url);
      saveStorageData(storageData);

      // Mostrar el enlace al usuario
      const linkElement = document.getElementById('dynamicLink');
      linkElement.href = nextLink.url;
      linkElement.innerText = 'Descargar Código PDF';
      linkElement.style.display = 'block';

      // Actualizar contador
      updateCounter();
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('getLinkButton').addEventListener('click', generateLink);
      updateCounter(); // Inicializar el contador al cargar la página
    });
  </script>
  <style>
    /* Restablecer diseño básico */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f9;
      color: #333;
    }
    #content {
      text-align: center;
      padding: 50px 20px;
    }
    #getLinkButton {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    #getLinkButton:hover {
      background-color: #45a049;
    }
    #dynamicLink {
      display: none;
      margin-top: 20px;
      font-size: 18px;
      color: #007BFF;
      text-decoration: none;
    }
    #dynamicLink:hover {
      text-decoration: underline;
    }
    #message {
      display: none;
      margin-top: 20px;
      font-size: 18px;
      color: red;
    }
    .counter {
      margin-top: 20px;
      font-size: 18px;
    }
    .counter span {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="content">
    <h1>¡Genera tu enlace único!</h1>
    <p>Cada usuario puede obtener un único enlace para descargar el código PDF. ¡Sé rápido antes de que se acaben los enlaces!</p>

    <button id="getLinkButton">Generar enlace de descarga</button>

    <a id="dynamicLink" href="#" target="_blank"></a>

    <div id="message">
      <p>¡Todos los enlaces han sido asignados! Gracias por participar.</p>
    </div>

    <div class="counter">
      <p>Enlaces usados: <span id="usedLinksCount">0</span></p>
      <p>Enlaces disponibles: <span id="availableLinksCount">0</span></p>
    </div>
  </div>
</body>
</html>
